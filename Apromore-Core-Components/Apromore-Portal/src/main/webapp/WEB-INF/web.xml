<?xml version="1.0" encoding="UTF-8"?>
<!--
  #%L
  This file is part of "Apromore Core".
  Copyright (C) 2011 - 2017 Queensland University of Technology.
  %%
  Copyright (C) 2018 - 2021 Apromore Pty Ltd.
  %%
  This program is free software: you can redistribute it and/or modify
  it under the terms of the GNU Lesser General Public License as
  published by the Free Software Foundation, either version 3 of the
  License, or (at your option) any later version.
  
  This program is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  GNU General Lesser Public License for more details.
  
  You should have received a copy of the GNU General Lesser Public
  License along with this program.  If not, see
  <http://www.gnu.org/licenses/lgpl-3.0.html>.
  #L%
  -->

<web-app xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xmlns="http://java.sun.com/xml/ns/javaee"
         xsi:schemaLocation="http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-app_3_0.xsd"
         id="WebApp_ID"
         version="3.0">

  <display-name>Apromore-Portal</display-name>

  <context-param>
    <param-name>contextClass</param-name>
    <param-value>org.springframework.osgi.web.context.support.OsgiBundleXmlWebApplicationContext</param-value>
  </context-param>

  <context-param>
    <param-name>contextConfigLocation</param-name>
    <param-value>
      classpath:META-INF/spring/portalContext.xml
      classpath*:META-INF/spring/managerClient-osgi-context.xml
    </param-value>
  </context-param>

  <!-- Jetty will not honor disabling URL rewriting via session-config/tracking-mode.  It must be done with this parameter instead. -->
  <context-param>
    <param-name>org.eclipse.jetty.servlet.SessionIdPathParameterName</param-name>
    <param-value>none</param-value>
  </context-param>

  <listener>
    <listener-class>org.zkoss.zk.ui.http.HttpSessionListener</listener-class>
  </listener>
  <listener>
    <listener-class>org.springframework.web.context.ContextLoaderListener</listener-class>
  </listener>
  <listener>
    <listener-class>org.springframework.web.context.request.RequestContextListener</listener-class>
  </listener>
  <listener>
    <listener-class>org.springframework.security.web.session.HttpSessionEventPublisher</listener-class>
  </listener>
  
   <filter>
    <filter-name>keycloakFilter</filter-name>
    <filter-class>org.springframework.web.filter.DelegatingFilterProxy</filter-class>
  </filter>
  
  <filter-mapping>
    <filter-name>keycloakFilter</filter-name>
    <url-pattern>/keycloak/*</url-pattern>
    <url-pattern>/*</url-pattern>
    <url-pattern>/j_spring_security_logout</url-pattern>
  </filter-mapping>
  
  <filter>
    <filter-name>authDetailsFilter</filter-name>
    <filter-class>org.springframework.web.filter.DelegatingFilterProxy</filter-class>
  </filter>
  
  <filter-mapping>
    <filter-name>authDetailsFilter</filter-name>
    <url-pattern>/*</url-pattern>
  </filter-mapping>

  <filter>
    <filter-name>portalFilter</filter-name>
    <filter-class>org.apromore.portal.PortalFilter</filter-class>
  </filter>
  <filter-mapping>
    <filter-name>portalFilter</filter-name>
    <url-pattern>/*</url-pattern>
  </filter-mapping> 


  <servlet>
    <description>ZK loader for ZUML pages</description>
    <servlet-name>zkLoader</servlet-name>
    <servlet-class>org.zkoss.zk.ui.http.DHtmlLayoutServlet</servlet-class>
    <init-param>
      <param-name>update-uri</param-name>
      <param-value>/zkau</param-value>
    </init-param>
    <load-on-startup>1</load-on-startup>
  </servlet>
  
  <servlet>
    <description>The asynchronous update engine for ZK</description>
    <servlet-name>auEngine</servlet-name>
    <servlet-class>org.zkoss.zk.au.http.DHtmlUpdateServlet</servlet-class>
  </servlet>
  
  <servlet>
    <servlet-name>resource</servlet-name>
    <servlet-class>org.apromore.portal.servlet.ResourceServlet</servlet-class>
  </servlet>
  
  <servlet>
  	<description>Communication channel for data requests in Apromore</description>
    <servlet-name>apromoreData</servlet-name>
    <servlet-class>org.apromore.portal.servlet.DataChannelServlet</servlet-class>
  </servlet>  
  
  <servlet>
    <servlet-name>newUserRegistration</servlet-name>
    <servlet-class>org.springframework.web.context.support.HttpRequestHandlerServlet</servlet-class>
  </servlet>
  
  <servlet>
    <servlet-name>resetPassword</servlet-name>
    <servlet-class>org.springframework.web.context.support.HttpRequestHandlerServlet</servlet-class>
  </servlet>
  
  <servlet>
    <servlet-name>portalPluginResource</servlet-name>
    <servlet-class>org.apromore.portal.servlet.PortalPluginResourceServlet</servlet-class>
  </servlet>

  <servlet-mapping>
    <servlet-name>zkLoader</servlet-name>
    <url-pattern>*.zul</url-pattern>
  </servlet-mapping>
  
  <servlet-mapping>
    <servlet-name>zkLoader</servlet-name>
    <url-pattern>*.zhtml</url-pattern>
  </servlet-mapping>
  
  <servlet-mapping>
    <servlet-name>auEngine</servlet-name>
    <url-pattern>/zkau/*</url-pattern>
  </servlet-mapping>
  
  <servlet-mapping>
    <servlet-name>apromoreData</servlet-name>
    <url-pattern>/dataRequest/*</url-pattern>
  </servlet-mapping> 
    
  <servlet-mapping>
    <servlet-name>resource</servlet-name>
    <url-pattern>/</url-pattern>  <!-- override the "default" servlet -->
  </servlet-mapping>

  <servlet-mapping>
    <servlet-name>newUserRegistration</servlet-name>
    <url-pattern>/register/newUserRegister/*</url-pattern>
  </servlet-mapping>
  
  <servlet-mapping>
    <servlet-name>resetPassword</servlet-name>
    <url-pattern>/register/resetPassword/*</url-pattern>
  </servlet-mapping>
  
  <servlet-mapping>
    <servlet-name>portalPluginResource</servlet-name>
    <url-pattern>/portalPluginResource/*</url-pattern>
  </servlet-mapping>

  <session-config>
    <session-timeout>30</session-timeout>
    <tracking-mode>SSL</tracking-mode>
    <tracking-mode>COOKIE</tracking-mode>
  </session-config>

  <mime-mapping>
    <extension>doc</extension>
    <mime-type>application/vnd.ms-word</mime-type>
  </mime-mapping>
  <mime-mapping>
    <extension>gif</extension>
    <mime-type>image/gif</mime-type>
  </mime-mapping>
  <mime-mapping>
    <extension>htm</extension>
    <mime-type>text/html</mime-type>
  </mime-mapping>
  <mime-mapping>
    <extension>html</extension>
    <mime-type>text/html</mime-type>
  </mime-mapping>
  <mime-mapping>
    <extension>jpeg</extension>
    <mime-type>image/jpeg</mime-type>
  </mime-mapping>
  <mime-mapping>
    <extension>jpg</extension>
    <mime-type>image/jpeg</mime-type>
  </mime-mapping>
  <mime-mapping>
    <extension>js</extension>
    <mime-type>text/javascript</mime-type>
  </mime-mapping>
  <mime-mapping>
    <extension>pdf</extension>
    <mime-type>application/pdf</mime-type>
  </mime-mapping>
  <mime-mapping>
    <extension>png</extension>
    <mime-type>image/png</mime-type>
  </mime-mapping>
  <mime-mapping>
    <extension>txt</extension>
    <mime-type>text/plain</mime-type>
  </mime-mapping>
  <mime-mapping>
    <extension>xls</extension>
    <mime-type>application/vnd.ms-excel</mime-type>
  </mime-mapping>
  <mime-mapping>
    <extension>xml</extension>
    <mime-type>text/xml</mime-type>
  </mime-mapping>
  <mime-mapping>
    <extension>zhtml</extension>
    <mime-type>text/html</mime-type>
  </mime-mapping>
  <mime-mapping>
    <extension>zul</extension>
    <mime-type>text/html</mime-type>
  </mime-mapping>

  <welcome-file-list>
    <welcome-file>index.zul</welcome-file>
  </welcome-file-list>
  <error-page>
    <error-code>401</error-code>
    <location>/pages/401.zul</location>
  </error-page>
  <error-page>
    <error-code>404</error-code>
    <location>/pages/404.zul</location>
  </error-page>
  <error-page>
    <exception-type>org.apromore.commons.exceptions.ServiceUnavailableException</exception-type>
    <location>/pages/500.zul</location>
  </error-page>
</web-app>
